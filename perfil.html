<!DOCTYPE html>
<html lang="pt-MZ">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Perfil - Luvano</title>
  <link rel="manifest" href="manifest.json"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{--azul:#1877f2;--azul-dark:#0d5ec9;--azul-light:#e7f0ff;--bg:#f0f2f5;--branco:#fff;--borda:#dde1e7;--texto:#1c1e21;--texto2:#65676b;--verde:#2e7d32;--vermelho:#e41e3f;}
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);}
    header{background:var(--azul);padding:0 16px;height:54px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:0 2px 8px rgba(24,119,242,.4);}
    .logo{color:#fff;font-size:20px;font-weight:800;text-decoration:none;display:flex;align-items:center;gap:6px;}
    .h-nav{display:flex;gap:6px;}
    .btn-h{color:rgba(255,255,255,.85);text-decoration:none;font-size:13px;padding:6px 11px;border-radius:6px;background:rgba(255,255,255,.15);}
    .btn-h:hover{background:rgba(255,255,255,.25);}

    /* SPINNER INICIAL */
    #pageLoad{display:flex;align-items:center;justify-content:center;min-height:60vh;}
    .spin{width:36px;height:36px;border:4px solid #dde1e7;border-top-color:var(--azul);border-radius:50%;animation:sp .7s linear infinite;}
    @keyframes sp{to{transform:rotate(360deg)}}

    .container{max-width:820px;margin:0 auto;padding:20px 14px;}
    /* HERO PERFIL */
    .perfil-hero{background:var(--branco);border-radius:14px;box-shadow:0 2px 12px rgba(0,0,0,.1);overflow:hidden;margin-bottom:16px;}
    .capa{height:140px;background:linear-gradient(135deg,#1877f2,#0d5ec9);}
    .hero-body{padding:0 22px 22px;position:relative;}
    .av-wrap{position:absolute;top:-44px;left:22px;width:86px;height:86px;border-radius:50%;border:4px solid var(--branco);background:var(--azul-light);display:flex;align-items:center;justify-content:center;font-size:38px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.15);}
    .av-wrap img{width:100%;height:100%;object-fit:cover;}
    .hero-top{display:flex;align-items:flex-end;justify-content:flex-end;height:52px;gap:8px;flex-wrap:wrap;}
    .btn-edit{padding:8px 16px;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;border:none;text-decoration:none;display:flex;align-items:center;gap:5px;}
    .be-p{background:var(--azul);color:#fff;}
    .be-s{background:var(--bg);color:var(--texto);}
    .be-d{background:#ffebee;color:var(--vermelho);border:2px solid #ffcdd2;}
    .perfil-nm{font-size:22px;font-weight:800;margin-bottom:3px;}
    .perfil-em{color:var(--texto2);font-size:13px;margin-bottom:8px;}
    .perfil-badges{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:12px;}
    .badge{padding:3px 12px;border-radius:20px;font-size:12px;font-weight:700;}
    .b-role{background:var(--azul-light);color:var(--azul);}
    .b-ver{background:#e8f5e9;color:var(--verde);}
    .stats-row{display:flex;gap:20px;flex-wrap:wrap;}
    .stat{text-align:center;}
    .stat-n{font-size:20px;font-weight:900;color:var(--azul);}
    .stat-l{font-size:11px;color:var(--texto2);}
    /* GRID CONTE√öDO */
    .g2{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
    @media(max-width:600px){.g2{grid-template-columns:1fr;}.capa{height:110px;}.hero-top{height:44px;}.av-wrap{width:74px;height:74px;font-size:32px;top:-36px;}.perfil-nm{font-size:19px;}.hero-body{padding:0 16px 18px;}}
    .card{background:var(--branco);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);padding:18px;}
    .card-t{font-size:16px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:7px;}
    .info-row{display:flex;justify-content:space-between;align-items:center;padding:9px 0;border-bottom:1px solid var(--borda);font-size:14px;}
    .info-row:last-child{border-bottom:none;}
    .ir-l{color:var(--texto2);}
    .ir-v{font-weight:600;text-align:right;}
    .link-card{display:flex;align-items:center;gap:9px;padding:11px;background:var(--bg);border-radius:8px;text-decoration:none;color:var(--texto);font-weight:600;font-size:14px;margin-bottom:8px;transition:background .15s;}
    .link-card:last-child{margin-bottom:0;}
    .link-card:hover{background:#e4e6e9;}
    .link-ic{font-size:18px;width:24px;text-align:center;}
    /* COMPRAS */
    .compra-item{display:flex;gap:11px;align-items:center;padding:11px 0;border-bottom:1px solid var(--borda);}
    .compra-item:last-child{border-bottom:none;}
    .compra-item img{width:52px;height:52px;border-radius:8px;object-fit:cover;flex-shrink:0;}
    .comp-nm{font-weight:700;font-size:14px;}
    .comp-meta{font-size:11px;color:var(--texto2);margin-top:2px;}
    .comp-val{font-size:15px;font-weight:800;color:var(--azul);margin-left:auto;white-space:nowrap;}
    #toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(90px);background:#323232;color:#fff;padding:11px 22px;border-radius:30px;font-size:14px;z-index:9999;transition:transform .3s;max-width:90vw;text-align:center;}
    #toast.on{transform:translateX(-50%) translateY(0);}
  </style>
</head>
<body>
<header>
  <a href="index.html" class="logo">üõçÔ∏è Luvano</a>
  <div class="h-nav">
    <a href="index.html" class="btn-h">üè† In√≠cio</a>
    <a href="notificacoes.html" class="btn-h">üîî</a>
    <a href="configuracoes.html" class="btn-h">‚öôÔ∏è</a>
  </div>
</header>

<div id="pageLoad"><div class="spin"></div></div>
<div id="pageContent" style="display:none">
  <div class="container">
    <!-- HERO -->
    <div class="perfil-hero">
      <div class="capa"></div>
      <div class="hero-body">
        <div class="av-wrap" id="avEl">üë§</div>
        <div class="hero-top">
          <a href="editar-perfil.html" class="btn-edit be-p">‚úèÔ∏è Editar</a>
          <a href="carteira.html" class="btn-edit be-s">üí≥ Carteira</a>
          <button onclick="logout()" class="btn-edit be-d">üö™ Sair</button>
        </div>
        <div class="perfil-nm" id="pNome">Carregando...</div>
        <div class="perfil-em" id="pEmail"></div>
        <div class="perfil-badges">
          <span class="badge b-role" id="pRole">üõí Cliente</span>
          <span class="badge b-ver">‚úÖ Verificado</span>
        </div>
        <div class="stats-row">
          <div class="stat"><div class="stat-n" id="sC">0</div><div class="stat-l">Compras</div></div>
          <div class="stat"><div class="stat-n" id="sP">0</div><div class="stat-l">Produtos</div></div>
          <div class="stat"><div class="stat-n" id="sF">0</div><div class="stat-l">Favoritos</div></div>
        </div>
      </div>
    </div>

    <div class="g2">
      <!-- INFO PESSOAL -->
      <div class="card">
        <div class="card-t">üë§ Informa√ß√µes Pessoais</div>
        <div class="info-row"><span class="ir-l">Nome</span><span class="ir-v" id="iNome">-</span></div>
        <div class="info-row"><span class="ir-l">Email</span><span class="ir-v" id="iEmail" style="font-size:12px">-</span></div>
        <div class="info-row"><span class="ir-l">Telem√≥vel</span><span class="ir-v" id="iTel">-</span></div>
        <div class="info-row"><span class="ir-l">Cidade</span><span class="ir-v" id="iCidade">-</span></div>
        <div class="info-row"><span class="ir-l">Tipo de conta</span><span class="ir-v" id="iRol">-</span></div>
        <div class="info-row"><span class="ir-l">Membro desde</span><span class="ir-v" id="iData">-</span></div>
      </div>
      <!-- LINKS R√ÅPIDOS -->
      <div class="card">
        <div class="card-t">üîó Acesso R√°pido</div>
        <a href="compras.html" class="link-card"><span class="link-ic">üì¶</span>Minhas Compras</a>
        <a href="favoritos.html" class="link-card"><span class="link-ic">‚ù§Ô∏è</span>Favoritos</a>
        <a href="meus-produtos.html" class="link-card"><span class="link-ic">üè™</span>Meus Produtos</a>
        <a href="vendedor.html" class="link-card"><span class="link-ic">üíº</span>Painel Vendedor</a>
        <a href="conversas.html" class="link-card"><span class="link-ic">üí¨</span>Mensagens</a>
        <a href="notificacoes.html" class="link-card"><span class="link-ic">üîî</span>Notifica√ß√µes</a>
      </div>
    </div>

    <!-- COMPRAS RECENTES -->
    <div class="card" style="margin-top:14px">
      <div class="card-t">üõí Compras Recentes <a href="compras.html" style="font-size:13px;color:var(--azul);font-weight:600;margin-left:auto;text-decoration:none">Ver todas ‚Üí</a></div>
      <div id="comprasEl"><div style="text-align:center;padding:20px;color:var(--texto2)">A carregar...</div></div>
    </div>
  </div>
</div>

<div id="toast"></div>
<script>
const SB_URL='https://SEU_PROJETO.supabase.co';
const SB_KEY='SUA_ANON_KEY_AQUI';
const {createClient}=supabase;
const sb=createClient(SB_URL,SB_KEY);
let user=null;

document.addEventListener('DOMContentLoaded',async()=>{
  const {data:{session}}=await sb.auth.getSession();
  if(!session){
    window.location.href='login.html?next=perfil.html';
    return;
  }
  user=session.user;
  await loadPerfil();
  document.getElementById('pageLoad').style.display='none';
  document.getElementById('pageContent').style.display='block';
});

async function loadPerfil(){
  const {data:p}=await sb.from('users').select('*').eq('id',user.id).single().catch(()=>({data:null}));
  if(p){
    const nm=p.nome||'Utilizador';
    document.getElementById('pNome').textContent=nm;
    document.getElementById('pEmail').textContent=p.email||user.email||'';
    document.getElementById('pRole').textContent=p.rol==='vendedor'?'üè™ Vendedor':p.rol==='admin'?'üõ°Ô∏è Admin':'üõí Cliente';
    document.getElementById('iNome').textContent=nm;
    document.getElementById('iEmail').textContent=p.email||user.email||'-';
    document.getElementById('iTel').textContent=p.telefone||'-';
    document.getElementById('iCidade').textContent=p.cidade||'-';
    document.getElementById('iRol').textContent=p.rol||'cliente';
    document.getElementById('iData').textContent=p.criado_em?new Date(p.criado_em).toLocaleDateString('pt-MZ'):'-';
    if(p.avatar)document.getElementById('avEl').innerHTML=`<img src="${p.avatar}" alt="${nm}"/>`;
  }

  // STATS
  const [rc,rp,rf]=await Promise.all([
    sb.from('pagamentos').select('*',{count:'exact',head:true}).eq('usuario_id',user.id).eq('status','confirmado'),
    sb.from('produtos').select('*',{count:'exact',head:true}).eq('vendedor_id',user.id).eq('ativo',true),
    sb.from('favoritos').select('*',{count:'exact',head:true}).eq('usuario_id',user.id),
  ]);
  document.getElementById('sC').textContent=rc.count||0;
  document.getElementById('sP').textContent=rp.count||0;
  document.getElementById('sF').textContent=rf.count||0;

  // COMPRAS RECENTES
  const {data:compras}=await sb.from('pagamentos').select('*,produtos(nome,fotos,preco)').eq('usuario_id',user.id).eq('status','confirmado').order('criado_em',{ascending:false}).limit(4);
  const el=document.getElementById('comprasEl');
  const DEMO=[{produtos:{nome:'iPhone 14 Pro',fotos:'["https://images.unsplash.com/photo-1695048133142-1a20484d2569?w=52&q=80"]',preco:65000},metodo:'mpesa',criado_em:new Date().toISOString(),valor:65000}];
  const lista=compras&&compras.length?compras:DEMO;
  el.innerHTML=lista.map(c=>{
    const fts=typeof c.produtos?.fotos==='string'?JSON.parse(c.produtos.fotos):(c.produtos?.fotos||[]);
    return `<div class="compra-item">
      <img src="${fts[0]||'https://via.placeholder.com/52'}" alt="" onerror="this.src='https://via.placeholder.com/52'"/>
      <div><div class="comp-nm">${c.produtos?.nome||'Produto'}</div><div class="comp-meta">${(c.metodo||'').toUpperCase()} ¬∑ ${new Date(c.criado_em).toLocaleDateString('pt-MZ')}</div></div>
      <div class="comp-val">MT ${Number(c.valor||c.produtos?.preco||0).toLocaleString('pt-MZ')}</div>
    </div>`;}).join('');
}

async function logout(){
  await sb.auth.signOut();
  window.location.href='login.html';
}

let toastT;
function showToast(msg,t='info'){
  const el=document.getElementById('toast');
  el.textContent=msg;el.style.background=t==='erro'?'#c62828':t==='sucesso'?'#2e7d32':'#323232';
  el.classList.add('on');clearTimeout(toastT);toastT=setTimeout(()=>el.classList.remove('on'),3200);
}
</script>
<script>if("serviceWorker"in navigator)navigator.serviceWorker.register("/service-worker.js");</script>
</body>
</html>
